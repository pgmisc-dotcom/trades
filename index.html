<script>
    // --- State ---
    let activeTab = 'summary';
    let useLivePrice = false;
    let sortConfig = { key: 'symbol', direction: 'asc' };

    const INITIAL_PORTFOLIOS = [];
    let portfolios = JSON.parse(localStorage.getItem('foliotrack_portfolios')) || INITIAL_PORTFOLIOS;

    if (portfolios.length > 0 && portfolios.some(p => ['Growth Tech', 'Dividend Yield', 'Crypto & Web3'].includes(p.name))) {
        localStorage.removeItem('foliotrack_portfolios');
        portfolios = [];
    }

    let strategyMappings = JSON.parse(localStorage.getItem('foliotrack_strategies')) || [];

    function savePortfolios() {
        localStorage.setItem('foliotrack_portfolios', JSON.stringify(portfolios));
    }

    function saveStrategies() {
        localStorage.setItem('foliotrack_strategies', JSON.stringify(strategyMappings));
    }

    let chartInstance = null;

    const formatCurrency = (value, decimals = 2) =>
        new Intl.NumberFormat('en-GB', {
            style: 'currency',
            currency: 'GBP',
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals,
        }).format(value);

    const formatPercent = (value) =>
        `${value > 0 ? '+' : ''}${value.toFixed(2)}%`;

    function switchTab(tabId) {
        activeTab = tabId;
        render();
    }

    function toggleLivePrice() {
        useLivePrice = !useLivePrice;
        render();
    }

    function render() {
        renderSidebar();
        renderHeader();
        renderContent();
        lucide.createIcons();
    }

    function renderContent() {
        const container = document.getElementById('content-area');
        if (activeTab === 'summary') {
            renderSummary(container);
        } else if (activeTab === 'strategies') {
            renderStrategies(container);
        } else {
            renderDetail(container);
        }
    }

    /* =======================
       SUMMARY CHART (FIXED)
    ======================== */

    function initSummaryChart() {
        const ctx = document.getElementById('allocationChart');
        if (!ctx) return;

        const data = portfolios.map(p => ({
            name: p.name,
            value: p.holdings.reduce((acc, h) => {
                const val = useLivePrice
                    ? (h.shares * (h.currentPrice || h.price * 1.05))
                    : h.value;
                return acc + val;
            }, 0) + (p.cash || 0),
            color: p.color
        }));

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.map(d => d.name),
                datasets: [{
                    data: data.map(d => d.value),
                    backgroundColor: data.map(d => d.color),
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { usePointStyle: true, padding: 20 }
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) =>
                                ` ${context.label}: ${formatCurrency(context.raw)}`
                        }
                    }
                },
                cutout: '70%'
            }
        });
    }

    /* =======================
       SECTOR CHART
    ======================== */

    function initSectorChart(data) {
        const ctx = document.getElementById('sectorChart');
        if (!ctx) return;

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.map(d => d.name),
                datasets: [{
                    data: data.map(d => d.value),
                    backgroundColor: data.map(d => d.color),
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                cutout: '70%'
            }
        });
    }

    render();
</script>
